---
layout: post
title: Querying and Visualizing Data
---

## ยง1. Create a Database

We begin by importing the relevant packages, including sqlite3 for sql, pandas to manipulate our data, and plotly to create graphs.

```python
import sqlite3
import pandas as pd
import plotly
```

Next, we will create our database, 'climate.db', and a cursor so that we can query our database.

```python
connection = sqlite3.connect('climate.db') # Create database
cursor = connection.cursor() # Create cursor
```

Now, we will populate our database.  We will do this by reading each file, making sure that the common columns are in the same format, and then enter them into 'climate.db'.

```python
dft = pd.read_csv("temperatures.csv") # Read temperatures file into dft
dft['ID2'] = dft["ID"].astype(str).str[:2] # Get the first two letters as country ID
dft.to_sql("temperatures", connection, if_exists = "replace", index = False) # Enter dft into climate

dfc = pd.read_csv("countries.csv") # Read countries file into dfc
dfc.to_sql("countries", connection, if_exists = "replace", index = False) # Enter dfc into climate

dfs = pd.read_csv("stations.csv") # Read stations file into dfs
dfs.to_sql("stations", connection, if_exists = "replace", index = False) # Enter dfs into climate
```

We have created our database!  All we need to do now is close our connection to the database.

```python
cursor.close()
```

## ยง2. Write a Query Function

Now, we will write a query function.  You start by opening the connection to the database, so that you can access that data, and the connect a cursor, as before.  Now, we can write our SQL query.  We start by using SELECT, and then name all the variables that we will need.  Then, we specify from which datasets within 'climate.db' we are accessing the variables from, and in this case, we need to left join the 'stations' and 'countries' files onto the 'temperatures' file so that we can access variables from all files.  Then, we specify conditions, using WHERE and AND to denote the relationship between our questions, in this case, that we want all of these things to be true.  Also, since this is a string, we have to end the string and add in new strings for the variables specified by the user in the function so that the string changes to retrieve the information that the user wants it to retrieve.

```python
def query_climate_database(country, year_begin, year_end, month):
    connection = sqlite3.connect('climate.db') # Open connection to database
    cursor = connection.cursor() # Connect cursor
    cmd = """SELECT S.NAME, S.LATITUDE, S.LONGITUDE, C.Name, T.Year, T.Month, T.Temp
             FROM temperatures T
             LEFT JOIN stations S ON T.ID = S.ID
             LEFT JOIN countries C ON T.ID2 = C.'FIPS 10-4'
             WHERE T.Year >= """ + str(year_begin) + """ 
             AND T.Year <= """ + str(year_end) + """
             AND C.Name == """ + "\"" + country + "\"" + """
             AND T.Month = """+ str(month) #SQL query
    dfa = pd.read_sql_query(cmd, connection)
    cursor.close()
    return dfa
```

Now we have a functioning SQL query function.

## ยง3.