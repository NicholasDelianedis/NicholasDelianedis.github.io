---
layout: post
title: Querying and Visualizing Data
---

## ยง1. Create a Database

We begin by importing the relevant packages, including sqlite3 for sql, pandas to manipulate our data, and plotly to create graphs.

```python
import sqlite3
import pandas as pd
import plotly
```

Next, we will create our database, 'climate.db', and a cursor so that we can query our database.

```python
connection = sqlite3.connect('climate.db') # Create database
cursor = connection.cursor() # Create cursor
```

Now, we will populate our database.  We will do this by reading each file, making sure that the common columns are in the same format, and then enter them into 'climate.db'.

```python
dft = pd.read_csv("temperatures.csv") # Read temperatures file into dft
dft['ID2'] = dft["ID"].astype(str).str[:2] # Get the first two letters as country ID
dft.to_sql("temperatures", connection, if_exists = "replace", index = False) # Enter dft into climate

dfc = pd.read_csv("countries.csv") # Read countries file into dfc
dfc.to_sql("countries", connection, if_exists = "replace", index = False) # Enter dfc into climate

dfs = pd.read_csv("stations.csv") # Read stations file into dfs
dfs.to_sql("stations", connection, if_exists = "replace", index = False) # Enter dfs into climate
```

We have created our database!  All we need to do now is close our connection to the database.

```python
cursor.close()
```

## ยง2. Write a Query Function

Now, we will write a query function.  You start by opening the connection to the database, so that you can access that data, and the connect a cursor, as before.  Now, we can write our SQL query.  We start by using SELECT, and then name all the variables that we will need.  Then, we specify from which datasets within 'climate.db' we are accessing the variables from, and in this case, we need to left join the 'stations' and 'countries' files onto the 'temperatures' file so that we can access variables from all files.  Then, we specify conditions, using WHERE and AND to denote the relationship between our questions, in this case, that we want all of these things to be true.  Also, since this is a string, we have to end the string and add in new strings for the variables specified by the user in the function so that the string changes to retrieve the information that the user wants it to retrieve.

```python
def query_climate_database(country, year_begin, year_end, month):
    connection = sqlite3.connect('climate.db') # Open connection to database
    cursor = connection.cursor() # Connect cursor
    cmd = """SELECT S.NAME, S.LATITUDE, S.LONGITUDE, C.Name, T.Year, T.Month, T.Temp
             FROM temperatures T
             LEFT JOIN stations S ON T.ID = S.ID
             LEFT JOIN countries C ON T.ID2 = C.'FIPS 10-4'
             WHERE T.Year >= """ + str(year_begin) + """ 
             AND T.Year <= """ + str(year_end) + """
             AND C.Name == """ + "\"" + country + "\"" + """
             AND T.Month = """+ str(month) #SQL query
    dfa = pd.read_sql_query(cmd, connection)
    cursor.close()
    return dfa
```

Now we have a functioning SQL query function.

## ยง3. Write a Geographic Scatter Function for Yearly Temperature Increases

Next, we will write a geographic scatter function for yearly temperature increases.  To start, we will define a function coef to find the slope of a linear regression model of data, which we will use to find the average yearly temperature increase at each station.  We start by importing the linear regression package, and then we define our function.  We fit the data into the linear regression model between "Year" and "Temp", and then find the slope coefficient of the model.  Then, we round that number to four decimal places.

```python
from sklearn.linear_model import LinearRegression

def coef(data_group):
    X = data_group[["Year"]] # X variable
    y = data_group["Temp"] # Y variable
    LR = LinearRegression() # Use linear regression
    LR.fit(X, y) # Fit linear model
    slope = LR.coef_[0] # Find slope
    slope = round(100000*slope)/100000 # Round to 4 digits
    return slope
```

Now, we can define our function.  We start by creating a string 'ttl' that will be the title of our graph, including some of the arguments set by the user.  Then we query the database with the information that we want to get our data.  Then, we create a new column, "numobs", for the number of observations using groupby, and then we select only the stations that have more than 'min_obs' observations, as desired.  Now, we use the coef function on our data, getting the average yearly increase for each station, and then reset the index so that it aligns with the dataset.  Then, we merge our dataset with coefs so that the coefficients are included in the dataset.  Now, we can create the actual map.  We will use the scatter_mapbox function, where we specify all the information that it needs, such as the dataset, title, latitude, longitude, hover name, and color.  Then, we show the figure.

```python
def temperature_coefficient_plot(country, year_begin, year_end, month, min_obs, **kwargs):
    ttl = "Estimates of yearly increase in temperature in month " + str(month) + " for stations in " + country + ", years " + str(year_begin) + " - " + str(year_end) # Title
    db = query_climate_database(country, year_begin, year_end, month) # Get required data from database
    db["numobs"] = db.groupby("LATITUDE")["Name"].transform(len) # Find number of observations
    dbo = db[db["numobs"] >= min_obs] # Only stations with at least min_obs observations
    coefs = dbo.groupby(["NAME", "Month"]).apply(coef) # Apply coef function to each group of station data
    coefs = coefs.reset_index() # Reset the index
    dbf = pd.merge(dbo, coefs) # Merge coefficients into dbo
    dbf["Estimated Yearly Temperature Increase"] = dbf[0]
    fig = px.scatter_mapbox(dbf, # Dataset
                            title = ttl, # Title
                            lat = "LATITUDE", # Latitude
                            lon = "LONGITUDE", # Longitude
                            hover_name = "NAME", # Name when you hover
                            color = "Estimated Yearly Temperature Increase", # Color of dots
                            color_continuous_midpoint = 0, # Midpoint at 0
                            height = 500, # Height of map
                            **kwargs) # Other user specified arguments
    fig.show() # Show figure
```

This is the result when we use this code to create a map of temperature change in India in January from 1980 to 2020:

```python
color_map = px.colors.diverging.RdGy_r # Create color map

temperature_coefficient_plot(country = "India", year_begin = 1980, year_end = 2020, month = 1, min_obs = 15,
                            zoom = 3, mapbox_style = "carto-positron", color_continuous_scale=color_map)
                            # Use our function
```
{% include India_temp_coef_plot.html %}